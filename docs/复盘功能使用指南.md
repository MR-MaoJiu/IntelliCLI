# 复盘功能使用指南

## 概述

复盘功能是IntelliCLI的高级特性，能够在任务执行完毕后自动分析结果，识别问题并提供改进建议。当执行结果不符合预期时，系统会自动生成补充计划进行查漏补缺，直到完全符合要求。

## 功能特性

### 🔍 智能分析
- **目标达成度评估**: 分析任务执行是否达到预期目标
- **问题识别**: 自动识别执行过程中的问题和不足
- **改进建议**: 基于LLM分析提供具体的改进建议
- **补充计划**: 自动生成修复计划来解决未完成的部分

### ⚙️ 灵活配置
- **启用开关**: 可在配置中控制是否启用复盘功能
- **自动/手动模式**: 支持任务完成后自动复盘或手动触发
- **复盘阈值**: 可设置触发复盘的成功率阈值
- **迭代限制**: 可配置最大改进迭代次数

### 📊 详细报告
- **执行统计**: 总步骤数、成功率、失败原因分析
- **整体评分**: 基于多维度指标的综合评分
- **分级评估**: 优秀/良好/及格/需改进四级评价
- **历史记录**: 保存所有任务执行和复盘历史

## 配置方法

### 1. 通过配置向导启用/关闭

```bash
intellicli config-wizard
```

在配置向导中会询问是否启用复盘功能：

```
任务复盘功能配置
任务复盘功能可以在任务完成后自动分析执行结果，
识别问题并提供改进建议。

是否启用任务复盘功能？(y/N): y
是否在任务完成后自动进行复盘？(y/N): y
请输入复盘阈值 (默认: 0.8): 0.8
请输入最大迭代次数 (默认: 3): 3
```

**注意**：如果选择 `N` 不启用，复盘功能将被完全关闭。

### 2. 手动配置文件

在 `config.yaml` 中添加或修改以下配置：

#### 启用复盘功能：
```yaml
task_review:
  enabled: true           # 启用复盘功能
  auto_review: true       # 自动复盘
  review_threshold: 0.8   # 复盘阈值（成功率低于此值时触发）
  max_iterations: 3       # 最大改进迭代次数
```

#### 关闭复盘功能：
```yaml
task_review:
  enabled: false          # 关闭复盘功能
  auto_review: false      # 关闭自动复盘
  review_threshold: 0.8   # 复盘阈值（即使关闭也保留配置）
  max_iterations: 3       # 最大改进迭代次数（即使关闭也保留配置）
```

#### 仅关闭自动复盘（保留手动复盘）：
```yaml
task_review:
  enabled: true           # 启用复盘功能
  auto_review: false      # 关闭自动复盘，但保留手动复盘
  review_threshold: 0.8   # 复盘阈值
  max_iterations: 3       # 最大改进迭代次数
```

### 3. 快速开启/关闭方法

#### 重新运行配置向导
```bash
# 重新配置所有设置（包括复盘功能）
intellicli config-wizard

# 或者重置配置后重新设置
intellicli config-reset
```

#### 直接编辑配置文件
```bash
# 查看当前配置
intellicli config

# 然后手动编辑 config.yaml 文件
# 将 task_review.enabled 设为 true（开启）或 false（关闭）
```

### 配置参数说明

- **enabled**: 是否启用复盘功能（默认: false）
  - `true`: 启用复盘功能，可以使用手动复盘和自动复盘
  - `false`: 完全关闭复盘功能，所有复盘相关命令都不可用
- **auto_review**: 是否在任务完成后自动复盘（默认: false）
  - `true`: 每次任务完成后自动进行复盘分析
  - `false`: 仅在手动调用或成功率低于阈值时进行复盘
- **review_threshold**: 复盘阈值，0.0-1.0之间（默认: 0.8）
  - 当任务成功率低于此值时，即使 `auto_review=false` 也会触发复盘
- **max_iterations**: 最大改进迭代次数（默认: 3）
  - 限制补充计划的执行次数，避免无限循环

## 如何开启和关闭复盘功能

### 🟢 开启复盘功能

#### 方法1：使用配置向导（推荐）
```bash
intellicli config-wizard
```
在向导中选择 `y` 启用复盘功能，并根据需要配置其他选项。

#### 方法2：直接编辑配置文件
编辑 `config.yaml` 文件，确保包含以下配置：
```yaml
task_review:
  enabled: true           # 必须设为 true
  auto_review: true       # 可选：是否自动复盘
  review_threshold: 0.8   # 可选：复盘阈值
  max_iterations: 3       # 可选：最大迭代次数
```

#### 方法3：重新配置
```bash
# 重置配置并重新设置
intellicli config-reset
```

### 🔴 关闭复盘功能

#### 方法1：使用配置向导
```bash
intellicli config-wizard
```
在向导中选择 `N` 不启用复盘功能。

#### 方法2：直接编辑配置文件
编辑 `config.yaml` 文件，将 `enabled` 设为 `false`：
```yaml
task_review:
  enabled: false          # 设为 false 关闭复盘功能
  auto_review: false      # 自动设为 false
  review_threshold: 0.8   # 保留配置值
  max_iterations: 3       # 保留配置值
```

#### 方法3：临时关闭（仅当次任务）
```bash
# 执行任务时不使用 --review 参数
intellicli task "你的任务"

# 即使配置了 auto_review=true，也不会进行复盘
```

### ⚙️ 部分开启（仅手动复盘）

如果你想保留复盘功能但关闭自动复盘：
```yaml
task_review:
  enabled: true           # 启用复盘功能
  auto_review: false      # 关闭自动复盘
  review_threshold: 0.8   # 保留阈值（低于此值仍会触发复盘）
  max_iterations: 3       # 保留迭代限制
```

这样配置后：
- 可以使用 `intellicli review` 手动复盘
- 可以使用 `intellicli task "任务" --review` 强制复盘
- 当任务成功率低于阈值时仍会自动复盘
- 正常成功的任务不会自动复盘

### 📋 检查复盘功能状态

```bash
# 查看当前配置状态
intellicli config

# 查看任务执行历史（包含复盘状态）
intellicli history
```

配置输出示例：
```
当前模型配置

🎯 主模型: deepseek

🤖 deepseek
   供应商: deepseek
   模型: deepseek-chat
   能力: general, code, reasoning

📋 复盘功能配置:
   启用状态: 是
   自动复盘: 是
   复盘阈值: 0.8
   最大迭代: 3
```

## 使用方法

### 1. 执行任务（支持复盘）

```bash
# 执行任务并启用复盘
intellicli task "创建一个Python计算器程序" --review

# 如果配置了auto_review=true，则无需--review参数
intellicli task "创建一个Python计算器程序"
```

### 2. 手动复盘

```bash
# 复盘最近的任务
intellicli review

# 复盘指定目标的任务
intellicli review --goal "计算器程序"

# 复盘并自动执行补充计划
intellicli review --auto-fix
```

### 3. 查看执行历史

```bash
# 查看所有任务执行历史
intellicli history
```

输出示例：
```
任务执行历史

1. ✅ 创建一个Python计算器程序
   成功率: 100.0% | 复盘: 🔍

2. 🟡 创建一个网站项目
   成功率: 85.0% | 复盘: 🔍

3. ❌ 部署到服务器
   成功率: 33.0% | 复盘: ⏸️
```

## 复盘流程

### 1. 自动触发条件
- 复盘功能已启用 (`enabled: true`)
- 满足以下任一条件：
  - 自动复盘已启用 (`auto_review: true`)
  - 任务成功率低于设定阈值 (`success_rate < review_threshold`)

### 2. 分析过程
1. **基础分析**: 统计执行步骤、成功率、失败原因
2. **目标达成度分析**: LLM分析是否达到原始目标
3. **问题识别**: 识别执行失败、计划质量、工具使用等问题
4. **改进建议**: 生成具体的改进建议
5. **补充计划**: 如需要，生成修复计划

### 3. 改进迭代
如果生成了补充计划且需要改进：
1. 执行补充计划
2. 分析补充执行结果
3. 检查是否达到满意结果
4. 如未达到且还有迭代次数，重新生成补充计划
5. 重复直到达到阈值或达到最大迭代次数

## 复盘报告示例

```
任务复盘

开始复盘分析（成功率: 67.0%，阈值: 80.0%）
📊 整体评分: 54.2/100
🏆 评级: 需改进
📝 总结: 任务执行存在重大问题，需要全面优化
🎯 目标达成度: 75%
⚠️ 发现 3 个问题:
   - 步骤 3 (shell) 执行失败
   - 计划可能过于简单，缺乏必要的步骤分解
   - 工具 shell 使用过于频繁 (4 次)
💡 改进建议:
   - 增加异常处理机制，确保程序稳定性
   - 优化任务分解策略，确保步骤之间的逻辑连贯性
   - 考虑优化 shell 的使用方式或合并相关操作

执行补充计划

第 1 次改进迭代
[执行步骤 1/2]: write_file...
[执行步骤 2/2]: shell...
✅ 第 1 次改进成功！
```

## 最佳实践

### 1. 配置建议
- **新手用户**: 启用自动复盘，阈值设为0.7，便于学习改进
- **高级用户**: 手动复盘，阈值设为0.9，专注于高质量执行
- **生产环境**: 关闭自动复盘，仅在需要时手动触发

### 2. 使用技巧
- 复盘功能特别适合复杂的多步骤任务
- 对于简单任务，可以关闭复盘以提高效率
- 定期查看执行历史，分析任务执行模式
- 利用改进建议优化未来的任务规划

### 3. 注意事项
- 复盘分析需要消耗LLM tokens，请合理使用
- 补充计划的执行也会产生实际操作，请确认后再执行
- 某些失败可能是环境问题，复盘无法解决所有问题

## 故障排除

### 常见问题与解决方案

#### 1. 复盘功能不工作
**问题**: 执行任务后没有进行复盘分析
**解决方案**:
- 检查配置文件中 `task_review.enabled` 是否为 `true`
- 确认LLM模型配置正确且可用
- 检查任务成功率是否低于设定阈值
- 使用 `intellicli config` 查看当前配置状态

#### 2. 不知道复盘功能是否已启用
**问题**: 不确定复盘功能的当前状态
**解决方案**:
```bash
# 查看配置状态
intellicli config

# 查看帮助信息，确认 review 命令是否可用
intellicli --help
```

#### 3. 想要重新配置复盘功能
**问题**: 需要修改复盘功能设置
**解决方案**:
```bash
# 重置配置
intellicli config-reset

# 重新运行配置向导
intellicli config-wizard
```

#### 4. 复盘功能启用但不工作
**问题**: 配置显示已启用但实际不工作
**解决方案**:
```bash
# 测试手动复盘
intellicli review --goal "测试目标"

# 查看历史记录
intellicli history

# 检查是否有错误日志
```

#### 5. 只想在特定任务使用复盘
**问题**: 不想每次都自动复盘
**解决方案**:
```bash
# 关闭自动复盘，但保留功能
# 在 config.yaml 中设置：
# task_review:
#   enabled: true
#   auto_review: false

# 然后在需要时手动启用
intellicli task "你的任务" --review
```

#### 6. 想要临时关闭复盘功能
**问题**: 某次任务不想进行复盘
**解决方案**:
```bash
# 执行任务时不使用 --review 参数
intellicli task "你的任务"

# 即使配置了 auto_review=true，也不会进行复盘
```

#### 7. 复盘功能完全不可用
**问题**: 所有复盘相关命令都无法使用
**解决方案**:
- 确认 `task_review.enabled` 为 `true`
- 重新运行配置向导：`intellicli config-wizard`
- 检查模型是否支持复盘功能
- 检查是否有语法错误在 config.yaml 中

### 复盘分析质量不佳
1. 尝试使用更强大的LLM模型
2. 提供更详细的任务描述
3. 检查执行结果是否包含足够的信息
4. 确保任务目标具体且可衡量

### 补充计划执行失败
1. 检查生成的补充计划是否合理
2. 确认工具和环境配置正确
3. 考虑手动调整补充计划
4. 降低 `max_iterations` 避免过度迭代

## 命令参考

```bash
# 任务执行
intellicli task <任务描述> [--review]

# 复盘管理
intellicli review [--goal <目标>] [--auto-fix]
intellicli history

# 配置管理
intellicli config-wizard
intellicli config
```

## 技术架构

复盘功能基于以下核心组件：

- **TaskReviewer**: 复盘分析器，负责分析和评估
- **Agent**: 智能代理，整合规划、执行和复盘
- **ModelConfigManager**: 配置管理，支持复盘选项
- **CLI命令**: 提供用户交互接口

复盘功能与现有的规划器(Planner)和执行器(Executor)无缝集成，形成完整的任务执行闭环。 